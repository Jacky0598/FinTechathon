import streamlit as st
import time
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
import re
import random

# -----------------------------------------------------------------
# é¡µé¢é…ç½® (Page Config)
# -----------------------------------------------------------------
# è®¾ç½®é¡µé¢æ ‡é¢˜ã€å›¾æ ‡å’Œå¸ƒå±€
st.set_page_config(
    page_title="Holistica Quant",
    page_icon="ğŸ¤–",
    layout="wide"
)


# -----------------------------------------------------------------
# æ¨¡æ‹Ÿçš„åç«¯APIè°ƒç”¨ (Mock Backend API Call) - å‡çº§ç‰ˆ
# -----------------------------------------------------------------
def call_holistica_backend(query):
    """
    æ¨¡æ‹Ÿè°ƒç”¨ Holistica Quant åç«¯çš„å¤šæ™ºèƒ½ä½“(Agent)å·¥ä½œæµã€‚
    è¿™ä¸ªå‡çº§ç‰ˆå¯ä»¥â€œå‡è£…â€åˆ†æä»»ä½•è‚¡ç¥¨ã€‚
    """

    # æ¨¡æ‹Ÿâ€œAIä¼´éšåˆ†æâ€çš„ä¾‹å­ [cite: 551-560]
    if "é»„é‡‘å’Œç¾è‚¡" in query:
        # (è¿™ä¸ªä¾‹å­æˆ‘ä»¬ä¿ç•™)
        with st.spinner("ğŸ¤– Holistica Agent æ­£åœ¨åˆ†æä¸­... (æ¨¡æ‹Ÿ)"):
            st.write_stream(_mock_agent_stream("Plan Team", "å·²æ”¶åˆ°è¯·æ±‚ï¼Œæ­£åœ¨åˆ¶å®šåˆ†æè®¡åˆ’..."))
            st.write_stream(_mock_agent_stream("Data Team", "æ­£åœ¨æŠ“å– DXY, XAUUSD, S&P500 æ•°æ®..."))
            st.write_stream(_mock_agent_stream("Strategy Team", "æ•°æ®åˆ†æå®Œæˆï¼Œæ­£åœ¨è®¡ç®—ç›¸å…³æ€§..."))
            time.sleep(2)  # æ¨¡æ‹Ÿè®¡ç®—

        # æ¨¡æ‹Ÿå›¾è¡¨æ•°æ®
        data = {
            'Date': pd.to_datetime(np.arange('2024-01', '2025-01', dtype='datetime64[M]')),
            'DXY': np.random.rand(12) + 100,
            'XAUUSD': np.random.rand(12) + 1800,
            'S&P500': np.random.rand(12) + 4000
        }
        df = pd.DataFrame(data).set_index('Date')

        report = """
        ### ç»¼åˆåˆ†ææŠ¥å‘Šï¼šç¾å…ƒã€é»„é‡‘ä¸ç¾è‚¡ç›¸å…³æ€§
        æˆ‘å·²æå–2024-2025å¹´DXYã€XAUUSDã€S&P500çš„æ•°æ®ã€‚
        **ç›¸å…³ç³»æ•°ä¸º:**
        * a. DXY ä¸ Gold: -0.72 (å¼ºè´Ÿç›¸å…³) [cite: 573]
        * b. DXY ä¸ S&P500: -0.45 (ä¸­åº¦è´Ÿç›¸å…³) [cite: 574]
        **ç»“è®º:**
        æ ¹æ®å†å²æ•°æ®ï¼Œç¾å…ƒè„±é’©é€šå¸¸ä¼šæå‡é»„é‡‘å¸å¼•åŠ›ï¼Œä½†å‰Šå¼±ç¾è‚¡æ”¶ç›Šã€‚ [cite: 575]
        """
        return {"report": report, "data": df}

    # ã€æ–°åŠŸèƒ½ã€‘ æ¨¡æ‹Ÿåˆ†æä»»æ„è‚¡ç¥¨
    # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼(re)æ¥åŒ¹é… "åˆ†æä¸€ä¸‹..." è¿™ç§æ¨¡å¼
    match = re.search(r"åˆ†æä¸€ä¸‹(.*)", query)

    if match:
        stock_name = match.group(1).strip()  # æå–è‚¡ç¥¨åç§°

        with st.spinner(f"ğŸ¤– Holistica Agent æ­£åœ¨åˆ†æ {stock_name} ... (æ¨¡æ‹Ÿ)"):
            st.write_stream(_mock_agent_stream("Plan Team", f"æ”¶åˆ° {stock_name} åˆ†æè¯·æ±‚ï¼Œåˆ¶å®šæ•°æ®æ”¶é›†è®¡åˆ’..."))
            st.write_stream(_mock_agent_stream("Data Team", f"æ­£åœ¨ä» AkShare æå– {stock_name} è´¢æŠ¥ã€Kçº¿æ•°æ®..."))
            st.write_stream(_mock_agent_stream("Strategy Team", "æ•°æ®å¤„ç†å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆç»¼åˆæŠ¥å‘Š..."))
            time.sleep(3)  # æ¨¡æ‹Ÿè®¡ç®—

        # è°ƒç”¨æ–°å‡½æ•°ï¼Œç”Ÿæˆä¸€ä»½ç¬¦åˆä½ ä»¬æ–‡æ¡£è§„èŒƒçš„â€œå‡â€æŠ¥å‘Š [cite: 774-809]
        report_content = _generate_fake_report(stock_name)
        return {"report": report_content, "data": _generate_fake_chart_data()}

    else:
        # é»˜è®¤çš„æ¨¡æ‹Ÿå›å¤
        with st.spinner("ğŸ¤– Holistica Agent æ­£åœ¨æ€è€ƒ..."):
            time.sleep(1)
        return {
            "report": "æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•ç†è§£æ‚¨çš„è¯·æ±‚ã€‚è¯·å°è¯•è¾“å…¥ï¼š\n- `å¸®æˆ‘çœ‹çœ‹ç¾å…ƒè„±é’©åé»„é‡‘å’Œç¾è‚¡çš„èµ°åŠ¿ç›¸å…³æ€§`\n- `åˆ†æä¸€ä¸‹ ç‰¹æ–¯æ‹‰`",
            "data": None}


def _mock_agent_stream(agent, text):
    """è¾…åŠ©å‡½æ•°ï¼šæ¨¡æ‹ŸAgentçš„å®æ—¶æ€è€ƒè¿‡ç¨‹"""
    yield f"**{agent}:** "
    for char in text:
        yield char
        time.sleep(0.02)
    yield "\n\n"


def _generate_fake_chart_data():
    """è¾…åŠ©å‡½æ•°ï¼šä¸ºä»»æ„è‚¡ç¥¨ç”Ÿæˆå‡çš„å›¾è¡¨æ•°æ®"""
    data = {
        'Date': pd.to_datetime(pd.date_range(start='2024-01-01', periods=90, freq='D')),
        'Price': np.random.rand(90).cumsum() + 100,  # æ¨¡æ‹Ÿä»·æ ¼
        'Volume': np.random.randint(100000, 500000, size=90)  # æ¨¡æ‹Ÿæˆäº¤é‡
    }
    df = pd.DataFrame(data).set_index('Date')
    return df


def _generate_fake_report(stock_name):
    """
    è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®ä½ ä»¬ã€ŠStructureè°ƒç ”.pdfã€‹ä¸­çš„Promptæ¨¡æ¿ï¼Œç”Ÿæˆä¸€ä»½å‡çš„ä¸“ä¸šæŠ¥å‘Š
    [cite: 774-809]
    """
    # éšæœºç”Ÿæˆä¸€äº›æ•°æ®
    rsi = round(random.uniform(30, 70), 2)
    macd = round(random.uniform(-0.5, 0.5), 2)
    roe = round(random.uniform(5, 25), 2)
    pe = round(random.uniform(10, 50), 2)

    # ä½¿ç”¨ f-string å’Œä¸‰é‡å¼•å·æ¥æ„å»ºå¤šè¡ŒMarkdownå­—ç¬¦ä¸²
    report = f"""
    ## {stock_name} ç»¼åˆåˆ†ææŠ¥å‘Š (æ¨¡æ‹Ÿæ•°æ®)

    ---

    ## ä¸€ã€æŠ€æœ¯é¢åˆ†æ [cite: 778]
    1.  **Kçº¿æŠ€æœ¯å½¢æ€**: è¿‘90æ—¥Kçº¿å›¾æ˜¾ç¤ºï¼Œ{stock_name} ç›®å‰å¤„äºéœ‡è¡ä¸Šè¡Œè¶‹åŠ¿ã€‚å…³é”®æ”¯æ’‘ä½åœ¨ {round(pe * 2.5, 2)}ï¼Œé˜»åŠ›ä½åœ¨ {round(pe * 3.5, 2)}ã€‚ [cite: 780]
    2.  **æŠ€æœ¯æŒ‡æ ‡ä¿¡å·**: [cite: 781]
        * **RSI**: å½“å‰RSIä¸º {rsi}ï¼Œå¤„äºä¸­æ€§åŒºé—´ã€‚
        * **MACD**: MACDå€¼ä¸º {macd}ï¼Œå¿«æ…¢çº¿æ¥è¿‘é‡‘å‰ï¼ŒåŠ¨èƒ½æŸ±è½»å¾®æ”¾é‡ã€‚

    ## äºŒã€åŸºæœ¬é¢åˆ†æ [cite: 783]
    1.  **ç›ˆåˆ©èƒ½åŠ›**: æœ€æ–°è´¢æŠ¥æ˜¾ç¤ºï¼Œå…¬å¸å‡€åˆ©ç‡ä¸º {round(roe / 2, 2)}%ï¼ŒROE (å‡€èµ„äº§æ”¶ç›Šç‡) ä¸º {roe}%ï¼Œç›ˆåˆ©èƒ½åŠ›å¼ºäºè¡Œä¸šå¹³å‡ã€‚ [cite: 784]
    2.  **è´¢åŠ¡å¥åº·åº¦**: èµ„äº§è´Ÿå€ºç‡ä¸º {round(random.uniform(20, 60), 2)}%ï¼Œç°é‡‘æµå……è£•ã€‚

    ## ä¸‰ã€å¸‚åœºç¯å¢ƒåˆ†æ [cite: 786]
    1.  **æ¿å—è¡¨ç°**: {stock_name} æ‰€å±æ¿å—è¿‘æœŸèµ„é‡‘å‘ˆå‡€æµå…¥çŠ¶æ€ã€‚ [cite: 787]
    2.  **èµ„é‡‘åŠ¨å‘**: æ•°æ®æ˜¾ç¤ºä¸»åŠ›èµ„é‡‘åœ¨è¿‡å»5æ—¥å†…å‘ˆè½»å¾®å‡€æµå…¥ã€‚ [cite: 788]

    ## å››ã€æ¶ˆæ¯é¢åˆ†æ [cite: 791]
    * (æ¨¡æ‹Ÿæ–°é—») {stock_name} äºæ˜¨æ—¥å®£å¸ƒä¸€é¡¹æ–°çš„AIåˆä½œè®¡åˆ’ï¼Œå¸‚åœºååº”ç§¯æã€‚ [cite: 793]

    ## äº”ã€ç»¼åˆè¯„ä¼° [cite: 796]
    1.  **æ ¸å¿ƒç»“è®º**: ç»¼åˆæŠ€æœ¯é¢ä¸åŸºæœ¬é¢ï¼Œ{stock_name} çŸ­æœŸçœ‹æ¶¨ï¼Œé•¿æœŸåŸºæœ¬é¢ç¨³å›ºã€‚ [cite: 797]
    2.  **å…³é”®é£é™©ç‚¹**: éœ€å…³æ³¨å®è§‚ç»æµæ³¢åŠ¨å¯¹æ¿å—çš„æ•´ä½“å½±å“ã€‚ [cite: 798]
    3.  **æ•°æ®å±€é™æ€§**: æœ¬æŠ¥å‘Šä¸ºAIæ¨¡æ‹Ÿç”Ÿæˆï¼ŒæœªåŒ…å«å…¨éƒ¨å®æ—¶æ•°æ®ã€‚ [cite: 799]
    """
    return report


# -----------------------------------------------------------------
# ä¾§è¾¹æ å¯¼èˆª (Sidebar Navigation)
# -----------------------------------------------------------------
# æ ¹æ®ä½ çš„TPRDæ–‡æ¡£å®šä¹‰4ä¸ªæ¨¡å— [cite: 48, 51, 76, 82]
st.sidebar.title("ğŸ¤– Holistica Quant")
st.sidebar.markdown("---")
page = st.sidebar.radio(
    "åŠŸèƒ½æ¨¡å— (Modules)",
    [
        "æ¬¢è¿ (Welcome)",
        "æ¨¡å—ä¸€ï¼šé‡‘èç§‘æŠ€å­¦ä¹  (FinTech Learning)",
        "æ¨¡å—äºŒï¼šæŠ•ç ”å®éªŒå®¤ (Investment Lab)",
        "æ¨¡å—ä¸‰ï¼šAIä¼´éšåˆ†æ (AI Companion)",
        "æ¨¡å—å››ï¼šå…¨çƒè¶‹åŠ¿ä¸æ–°é—» (News & Trends)"
    ],
    captions=[
        "é¡¹ç›®ä»‹ç»",
        "AIäº’åŠ¨è®²å¸ˆ",
        "è™šæ‹ŸæŠ•èµ„ä¸å›æµ‹",
        "è‡ªç„¶è¯­è¨€é©±åŠ¨åˆ†æ",
        "è´¢æŠ¥ä¸é»‘å¤©é¹…è¿½è¸ª"
    ]
)
st.sidebar.markdown("---")
st.sidebar.info("å¾®ä¼—é“¶è¡Œé‡‘èç§‘æŠ€å¤§èµ› [cite: 470]")

# -----------------------------------------------------------------
# é¡µé¢å†…å®¹ (Page Content)
# -----------------------------------------------------------------

if page == "æ¬¢è¿ (Welcome)":
    st.title("æ¬¢è¿æ¥åˆ° Holistica Quant ğŸ¤–")
    st.subheader("AIé©±åŠ¨çš„æ·±åº¦æ´è§ä¸ç ”ç©¶åˆ†æ | è™šæ‹Ÿé‡åŒ–æŠ•èµ„å®éªŒå®¤ [cite: 3]")
    st.markdown("""
    æœ¬é¡¹ç›®æ˜¯ä¸ºå¾®ä¼—é“¶è¡Œé‡‘èç§‘æŠ€å¤§èµ›æ‰“é€ çš„è§£å†³æ–¹æ¡ˆã€‚

    **ç›®æ ‡ç”¨æˆ·:** [cite: 43]
    * é‡‘èç§‘æŠ€ä¸“ä¸šå­¦ç”Ÿ [cite: 526]
    * é‡åŒ–ç ”ç©¶è€…ä¸å¼€å‘è€…
    * é‡‘èæœºæ„åˆ›æ–°å®éªŒå®¤ [cite: 35]

    **è§£å†³çš„ç—›ç‚¹:** [cite: 9]
    1.  **é‡‘èå­¦ä¹ é—¨æ§›é«˜:** çŸ¥è¯†ä½“ç³»åºå¤§ï¼Œå·¥å…·ç¢ç‰‡åŒ–ã€‚ [cite: 14]
    2.  **äº§å­¦ç ”è„±èŠ‚:** é«˜æ ¡è¯¾ç¨‹ä¸è¡Œä¸šå®è·µè„±èŠ‚ï¼Œç¼ºå°‘å®æ“å¹³å°ã€‚ [cite: 21, 22]
    3.  **ä¿¡æ¯è¿‡è½½:** å¸‚åœºä¿¡æ¯çˆ†ç‚¸ï¼Œä½†ç¼ºä¹å¯ä¿¡ã€å¯è§£é‡Šçš„æ™ºèƒ½è¾…åŠ©ã€‚ [cite: 861]

    è¯·åœ¨å·¦ä¾§ä¾§è¾¹æ é€‰æ‹©ä¸€ä¸ªæ¨¡å—å¼€å§‹ä½“éªŒã€‚
    """)

elif page == "æ¨¡å—ä¸€ï¼šé‡‘èç§‘æŠ€å­¦ä¹  (FinTech Learning)":
    st.title("ğŸ“š æ¨¡å—ä¸€ï¼šé‡‘èç§‘æŠ€å­¦ä¹ ")
    st.info("æ­¤æ¨¡å—è®©AIå……å½“â€œäº’åŠ¨è®²å¸ˆ+å®éªŒæŒ‡å¯¼â€ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£æ ¸å¿ƒæœºåˆ¶ã€‚ [cite: 49]")

    # æ¨¡æ‹Ÿå­¦ä¹ ä¸»é¢˜ [cite: 50]
    topic = st.selectbox(
        "é€‰æ‹©ä¸€ä¸ªå­¦ä¹ ä¸»é¢˜ï¼š",
        ["æ”¯ä»˜ (Payment)", "å‚¨è“„ä¸å€Ÿè´· (Lending)", "æŠ•èµ„ç®¡ç† (Investment)", "å¸‚åœºé¢„æµ‹ (Forecasting)"]
    )
    st.write(f"ä½ é€‰æ‹©äº†: **{topic}**")

    # æ­¤å¤„å¯ä»¥åµŒå…¥ä¸€ä¸ªç®€å•çš„èŠå¤©æœºå™¨äººç•Œé¢
    st.chat_input("è¯·å‘AIè®²å¸ˆæé—® (ä¾‹å¦‚ï¼šä»€ä¹ˆæ˜¯P2Pï¼Ÿ)")

elif page == "æ¨¡å—äºŒï¼šæŠ•ç ”å®éªŒå®¤ (Investment Lab)":
    st.title("ğŸ”¬ æ¨¡å—äºŒï¼šæŠ•ç ”å®éªŒå®¤")
    st.info("æ­¤æ¨¡å—æä¾›è™šæ‹ŸAIæŠ•ç ”å®éªŒå®¤ï¼Œç”¨äºæ„å»ºå’Œæµ‹è¯•æŠ•èµ„ç­–ç•¥ã€‚ [cite: 52]")

    # æ¨¡æ‹Ÿå®éªŒ1ï¼šç‰¹æ–¯æ‹‰ä¼°å€¼ [cite: 57]
    st.subheader("å®éªŒæ¡ˆä¾‹ï¼šç‰¹æ–¯æ‹‰(TSLA)ä¼°å€¼æ˜¯å¦åˆç†ï¼Ÿ [cite: 57]")
    if st.button("å¼€å§‹åŸºæœ¬é¢åˆ†æå®éªŒ"):
        with st.spinner("AIæ­£åœ¨æå–Teslaè´¢æŠ¥ (2020-2025) å¹¶ä¸Fordã€BYDå¯¹æ¯”... [cite: 59, 61]"):
            time.sleep(3)
            st.success("åˆ†æå®Œæˆï¼")
            st.markdown("#### æŠ•ç ”æŠ¥å‘Šï¼šã€ŠFundamental Valuation of Tesla (2020-2025)ã€‹ [cite: 64]")
            st.write("AIåˆ†æç»“è®ºï¼šHold (æ¨¡æ‹Ÿ) [cite: 62]")

elif page == "æ¨¡å—ä¸‰ï¼šAIä¼´éšåˆ†æ (AI Companion)":
    st.title("ğŸ¤ æ¨¡å—ä¸‰ï¼šAIä¼´éšåˆ†æ (AI Companion)")
    st.info("ä¸€ä¸ªâ€œæ‡‚é‡‘èç§‘æŠ€â€çš„æ™ºèƒ½AIåŠ©æ‰‹ï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€ä¸æ‚¨ä¼´éšåˆ†æã€è§£é‡Šã€ç”ŸæˆæŠ¥å‘Šã€‚ [cite: 77, 79]")

    # è¿™æ˜¯æ ¸å¿ƒäº¤äº’ç•Œé¢
    default_query = "å¸®æˆ‘çœ‹çœ‹ç¾å…ƒè„±é’©åé»„é‡‘å’Œç¾è‚¡çš„èµ°åŠ¿ç›¸å…³æ€§ã€‚"
    query = st.text_area("è¯·è¾“å…¥ä½ çš„åˆ†æè¯·æ±‚:", value=default_query, height=100)

    if st.button("ğŸš€ å¼€å§‹åˆ†æ"):
        if query:
            # 1. è°ƒç”¨åç«¯ (Call Backend)
            result = call_holistica_backend(query)

            # 2. æ˜¾ç¤ºç»“æœ (Display Results)
            st.markdown("---")
            st.markdown(result["report"])  # æ˜¾ç¤ºAIç”Ÿæˆçš„æŠ¥å‘Š

            # 3. æ˜¾ç¤ºå›¾è¡¨ (Display Charts)
            if result["data"] is not None:
                st.subheader("ç›¸å…³æ€§èµ°åŠ¿å›¾è¡¨")
                # æ¨¡æ‹Ÿå›¾è¡¨
                fig, ax = plt.subplots()
                if "Price" in result["data"].columns:
                    # æ¨¡æ‹Ÿè‚¡ç¥¨å›¾
                    result["data"]['Price'].plot(ax=ax, grid=True, title=f"{query} (æ¨¡æ‹Ÿä»·æ ¼èµ°åŠ¿)")
                    ax.set_ylabel("Price")
                else:
                    # æ¨¡æ‹Ÿé»„é‡‘/ç¾è‚¡å›¾
                    result["data"][['DXY', 'XAUUSD', 'S&P500']].plot(ax=ax, subplots=True, layout=(3, 1), grid=True,
                                                                     title="DXY, XAUUSD, S&P500 (æ¨¡æ‹Ÿæ•°æ®)")

                plt.tight_layout()
                st.pyplot(fig)
        else:
            st.error("è¯·è¾“å…¥åˆ†æè¯·æ±‚ã€‚")

elif page == "æ¨¡å—å››ï¼šå…¨çƒè¶‹åŠ¿ä¸æ–°é—» (News & Trends)":
    st.title("ğŸ“° æ¨¡å—å››ï¼šå…¨çƒè¶‹åŠ¿ä¸æ–°é—»")
    st.info("å®æ—¶è¿½è¸ªå…¨çƒé‡‘èç§‘æŠ€è¶‹åŠ¿ã€æœ€æ–°è´¢æŠ¥ä¸é»‘å¤©é¹…äº‹ä»¶ã€‚ [cite: 83, 85]")

    st.subheader("å…¨çƒè´¢æŠ¥è¿½è¸ªä¸AIè§£è¯» (æ¨¡æ‹Ÿ) [cite: 86]")
    st.markdown("""
    * **è‹¹æœ (AAPL)**: Q4 è´¢æŠ¥å‘å¸ƒï¼Œè¥æ”¶è¶…é¢„æœŸã€‚
    * **è‹±ä¼Ÿè¾¾ (NVDA)**: AIèŠ¯ç‰‡éœ€æ±‚æŒç»­å¼ºåŠ²ï¼ŒæŒ‡å¼•ä¸Šè°ƒã€‚
    * **ç‰¹æ–¯æ‹‰ (TSLA)**: äº¤ä»˜é‡æœªè¾¾é¢„æœŸï¼Œè‚¡ä»·æ³¢åŠ¨ã€‚
    """)

    st.subheader("é»‘å¤©é¹…ä¸“åŒº (æ¨¡æ‹Ÿ) [cite: 83]")
    st.warning("çªå‘ï¼šæŸå¤§å‹èˆªè¿å…¬å¸å®£å¸ƒå› ä¸å¯æŠ—åŠ›æš‚åœçº¢æµ·èˆªçº¿ï¼Œå…¨çƒä¾›åº”é“¾é¢ä¸´è€ƒéªŒã€‚")

    st.subheader("å­¦æœ¯åœˆæ–°æ¶ˆæ¯ (æ¨¡æ‹Ÿ) [cite: 82]")
    st.write("æœ€æ–°ç ”ç©¶ï¼šLangGraph åœ¨å¤šæ™ºèƒ½ä½“åä½œä¸­çš„åº”ç”¨æ˜¾è‘—æå‡äº†é‡‘èä¿¡å·å‘ç°çš„æ•ˆç‡ã€‚")